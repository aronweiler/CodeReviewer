name: Code Refactor

on:
  workflow_dispatch:  # Triggered manually through the GitHub UI
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'
      tags:
        description: 'Test scenario tags'  

jobs:
  code_review:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Get branch list
        id: branch_list
        run: |
          branches=$(git branch -r --format='%(refname:short)' | grep -v HEAD)
          branch_array=($branches)
          echo "::set-output name=branches::${branch_array[@]}"
        shell: bash
        
      - name: Input variables
        id: input_vars
        run: |
          echo "type=${{ github.event.inputs.type }}"
          echo "source_branch=${{ github.event.inputs.source_branch }}"
          echo "target_branch=${{ github.event.inputs.target_branch }}"
        shell: bash
        
      - name: Start code review step
        id: code_review
        uses: aronweiler/codereviewer@main
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          type: ${{ steps.input_vars.outputs.type }}
          source_branch: ${{ steps.input_vars.outputs.source_branch }}
          target_branch: ${{ steps.input_vars.outputs.target_branch }}
